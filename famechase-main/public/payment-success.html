<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Payment Success - Famechase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; color:#222; }
    h1 { color:#0b6; }
    .status { margin: 16px 0; }
    #download-list a { display:block; margin:8px 0; color: #0074D9; text-decoration:none; }
    #download-list a:hover { text-decoration:underline; }
    .error { color: #b02; }
    .muted { color:#666; font-size:0.95rem; }
  </style>
</head>
<body>
  <h1>Payment Successful — Verifying...</h1>
  <p id="status" class="status">Please wait while we verify your payment and prepare your downloads.</p>

  <div id="download-list" style="display:none;">
    <h2>Your downloads</h2>
    <div id="downloads"></div>
  </div>

  <p class="muted">If verification fails or you do not see downloads, contact support at support@famechase.com and include your Instamojo payment id.</p>

  <script>
    (async function () {
      // Read token/pid from URL - try common param names Instamojo uses
      const params = new URLSearchParams(location.search)
      const paymentId = params.get('payment_id') || params.get('id') || params.get('token') || params.get('payment_request_id')

      if (!paymentId) {
        document.getElementById('status').textContent = 'No payment id found in the URL. If you were redirected here from Instamojo, please contact support.'
        document.getElementById('status').classList.add('error')
        return
      }

      document.getElementById('status').textContent = 'Verifying payment with our server...'

      try {
        // Call the Netlify function that verifies the payment server-side
        const res = await fetch('/.netlify/functions/instamojo-verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ payment_id: paymentId })
        })

        const json = await res.json()

        if (!res.ok) {
          document.getElementById('status').textContent = 'Server error during verification: ' + (json.error || res.status)
          document.getElementById('status').classList.add('error')
          return
        }

        if (json.ok) {
          document.getElementById('status').textContent = 'Payment verified — your downloads are ready.'
          const dlWrap = document.getElementById('download-list')
          const dlContainer = document.getElementById('downloads')
          dlWrap.style.display = 'block'
          dlContainer.innerHTML = ''

          if (json.downloads && json.downloads.length) {
            json.downloads.forEach(d => {
              const a = document.createElement('a')
              a.href = d.url
              a.textContent = d.name || d.url
              a.target = '_blank'
              dlContainer.appendChild(a)
            })
          } else {
            dlContainer.textContent = 'Files unlocked. If you do not see links, refresh after a moment or contact support.'
          }
        } else {
          document.getElementById('status').textContent = 'Payment could not be verified: ' + (json.message || JSON.stringify(json))
          document.getElementById('status').classList.add('error')
        }
      } catch (err) {
        document.getElementById('status').textContent = 'Network error during verification: ' + err.message
        document.getElementById('status').classList.add('error')
      }
    })()
  </script>
</body>
</html>
