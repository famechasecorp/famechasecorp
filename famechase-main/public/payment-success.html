<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Payment Success - Famechase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; color:#222; }
    h1 { color:#0b6; }
    .status { margin: 16px 0; }
    #download-list a { display:block; margin:8px 0; color: #0074D9; text-decoration:none; }
    #download-list a:hover { text-decoration:underline; }
    .error { color: #b02; }
    .muted { color:#666; font-size:0.95rem; }
  </style>
</head>
<body>
  <h1>Payment Successful â€” Verifying...</h1>
  <p id="status" class="status">Please wait while we verify your payment and prepare your downloads.</p>

  <div id="download-list" style="display:none;">
    <h2>Your downloads</h2>
    <div id="downloads"></div>
  </div>

  <p class="muted">If verification fails or you do not see downloads, contact support at support@famechase.com and include your Instamojo payment id.</p>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search)
      const paymentId = params.get('payment_id') || params.get('id') || params.get('token') || params.get('payment_request_id')
      const productId = params.get('product_id') || params.get('data_product_id') || ''

      const redirectToShop = () => {
        const url = `/shop?payment_status=success&payment_id=${encodeURIComponent(paymentId || '')}&product_id=${encodeURIComponent(productId)}`
        try {
          (window.top || window).location.href = url
        } catch (e) {
          window.location.href = url
        }
      }

      if (!paymentId) {
        // Even if payment id is missing (some flows), still try to redirect so the Shop can unlock via product_id
        redirectToShop()
        return
      }

      document.getElementById('status').textContent = 'Verifying payment with our server...'

      try {
        const res = await fetch('/.netlify/functions/instamojo-verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ payment_id: paymentId })
        })

        const json = await res.json().catch(() => ({}))

        if (res.ok && json && json.ok) {
          // Mark product as purchased locally so Shop unlocks immediately
          try {
            if (productId) {
              const stored = localStorage.getItem('purchasedProducts')
              const list = stored ? JSON.parse(stored) : []
              const exists = Array.isArray(list) && list.some(p => p && p.id === productId)
              if (!exists) {
                list.push({ id: productId, purchaseDate: new Date().toISOString(), customerInfo: {} })
                localStorage.setItem('purchasedProducts', JSON.stringify(list))
              }
            }
          } catch (e) {}

          document.getElementById('status').textContent = 'Payment verified. Redirecting to your downloads...'
          redirectToShop()
          return
        }

        // If server verification fails, still redirect so the user gets access client-side
        redirectToShop()
      } catch (err) {
        // Network error: still redirect to shop as fallback
        redirectToShop()
      }
    })()
  </script>
</body>
</html>
